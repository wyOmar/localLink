<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LocalLink - Watcher</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">
    <link rel="shortcut icon" href="/favicon/favicon.ico">
    <!-- Load Socket.IO client from CDN -->
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
  </head>
  <body>
    <header>
      <a href="/" class="app-logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path
            d="M13 19h-2v-8H5v8H3V5h2v4h6V5h2v14zm8-4h-5v2h5v2H9v-6h7v-2H9V9h12v6z"
          />
        </svg>
        <span>LocalLink</span>
      </a>
    </header>

    <main class="container">
      <div class="card">
        <h1 class="app-title mb-2">Watcher</h1>
        <p class="mb-4">
          View a broadcast from another device on your local network.
        </p>

        <div id="status-container" class="status-indicator connecting mb-4">
          <span class="dot"></span>
          <span id="status">Waiting for broadcaster...</span>
        </div>

        <div class="video-container">
          <video id="video" controls autoplay playsinline></video>
        </div>
      </div>
      <div class="card" style="margin-top:2em;">
        <h2>Remote Recommendations</h2>
        <input id="codeInput" placeholder="Enter 4-digit code" maxlength="4" />
        <button onclick="setCode()">Connect</button>
        <div id="recommendations"></div>
      </div>
      <script>
        let code = "";
      
        function setCode() {
          code = document.getElementById("codeInput").value.trim();
          if (code.length === 4) {
            loadRecs();
            setInterval(loadRecs, 5000);
          }
        }
      
        async function loadRecs() {
          if (!code) return;
          const res = await fetch(
            `https://locallink-signaling-0763fb08f9e9.herokuapp.com/recommendations/${code}`
          );
          const recs = await res.json();
          const recsDiv = document.getElementById("recommendations");
          recsDiv.innerHTML = "";
          recs.forEach((rec) => {
            const div = document.createElement("div");
            div.className = "rec";
            div.style.cursor = "pointer";
            div.style.border = "1px solid #ccc";
            div.style.padding = "10px";
            div.style.marginBottom = "20px";
            div.style.display = "flex";
            div.style.alignItems = "center";
            div.onclick = () => navigate(rec.url);
            div.innerHTML = `
              <img src="${rec.thumbnail}" style="width:120px;height:auto;margin-right:10px;" />
              <div>
                <b>${rec.title}</b><br>
                ${rec.channel} - ${rec.views} - ${rec.posted}
              </div>
            `;
            recsDiv.appendChild(div);
          });
        }
      
        async function navigate(url) {
          if (!code) return;
          await fetch(
            `https://locallink-signaling-0763fb08f9e9.herokuapp.com/navigate/${code}`,
            {
              method: "POST",
              headers: { "Content-Type": "text/plain" },
              body: url,
            }
          );
        }
      </script>
      
    </main>

    <!-- Load the external watcher script -->
    <script src="watcher.js"></script>
  </body>
</html>
